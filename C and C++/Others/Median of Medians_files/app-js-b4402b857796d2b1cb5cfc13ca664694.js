(function(root){var App=root.App={max_tags_allowed:4,loggedInContext:null,socketContext:null,init:function(){this.ajaxSetup();this.loggedInContext=$.getJSON("/user");},ajaxSetup:function(){$.ajaxSetup({headers:{'X-CSRF-Token':$('meta[name="csrf-token"]').attr('content')}});}};App.init();})(this);(function(root){root.Utils={mdConverter:null,tTmpl:null,convertHTML:function(data){if(!this.mdConverter){this.mdConverter=new Markdown.Converter();}
return this.mdConverter.makeHtml(data);},error:function(xhr){var error=JSON.parse(xhr.responseText);if(error){if(error.error&&error.error.message){return error.error.message;}else if(error.message){return error.message;}}
return null;},showAlert:function(message,type){if(!message)return;var tmpl=_.template($('#pageAlertTmpl').html());$('#pageAlert').html(tmpl({'message':message,'type':type||"danger"}));$("#pageAlert").alert();},notify:function(message,type,title){if(!message)return;type=type||'notice';$.growl[type]({message:message,'location':'br',duration:5000,title:title||''});},gravatar:function(gcode,size){if(!gcode)return;size=size||48;return"http://www.gravatar.com/avatar/"+gcode+"?d=identicon&s="+size;},getDate:function(str){return new Date(str.replace(' ','T'));},confirmBox:function(options){var opts=_.defaults(options,{body:'',url:'#',title:'Confirm',okCallback:_.identity,cancelCallback:_.identity});var tl=_.template($('#confirmTmpl').html());var modal=$('#confirmBoxModal');modal.html(tl(opts)).on("show.bs.modal",function(){modal.find(".ok-button").on("click",function(e){modal.modal('hide');opts.okCallback&&opts.okCallback();});modal.find(".cancel-button").on("click",function(e){modal.modal('hide');opts.cancelCallback&&opts.cancelCallback();});}).on("hide.bs.modal",function(){modal.find(".ok-button, .cancel-button").off("click");}).on("hidden.bs.modal",function(){modal.empty();modal.off('show.bs.modal hide.bs.modal hidden.bs.modal');});modal.modal('show');},titleCount:function(count){count=parseInt(count||0);var t=document.title;if(t){t=t.replace(/^(\(\d+\) )/,"");if(count>0){t="("+count+") "+t;}
document.title=t;}},urlParam:function(param){var pageUrl=window.location.search.substring(1);var urlVar=pageUrl.split('&');for(var i=0;i<urlVar.length;i++){var paramName=urlVar[i].split('=');if(paramName[0]==param){return paramName[1];}}},restartMathJax:function(divId){setTimeout(function(){try{var data=["Typeset",MathJax.Hub];divId&&data.push(divId);MathJax.Hub.Queue(data);}catch(e){}},10);}};})(this);(function($){var notificationTemplate=_.template($('#notificationTmpl').html());var featureTemplate=_.template($('#featureTmpl').html());var dnsTemplate=_.template($('#dnsTmpl').html());var userInfoTemplate=_.template($('#userInfoTmpl').html());var tagModalTemplate=_.template($('#tagmodalTmpl').html());var notifyTemplate=_.template($('#notifyTmpl').html());Utils.titleCount($('#notification_count').html());$('#notificationModal').on('show.bs.modal',function(){$.getJSON('/notification/feed').done(function(result){$('#notificationModal .notification-list').empty();result&&result.data&&showNotification(result.data);});$.getJSON('/notification/discussion').done(function(result){$('#notificationModal .dns-list').empty();result&&result.data&&showDN(result.data);});});$('.notification-clearall').on('click',function(){$.ajax({type:'DELETE',url:'/notification',dataType:'json'}).done(function(){$(".notification-list").empty();$("#notification_count").html(0);Utils.titleCount(0);}).fail(function(xhr,errorType,msg){Utils.showAlert(Utils.error(xhr)||msg||'Unknown Error');});});$('.feature-allseen').on('click',function(){$.ajax({type:'DELETE',url:'/feature/allseen'}).done(function(){$(".feature-list").empty();$("#feature_count").html(0);$('li.feature-li').addClass('hide');Utils.titleCount(0);}).fail(function(xhr,errorType,msg){Utils.showAlert(Utils.error(xhr)||msg||'Unknown Error');});});$('#featureModal').on('show.bs.modal',function(){$.getJSON('/feature/feeds').done(function(result){$('#featureModal .feature-list').empty();result&&result.data&&showFeature(result.data);});});function showNotification(results,method){method=method||'append';$('#notificationModal .notification-list')[method](notificationTemplate({notifications:results}));}
function showDN(results,method){method=method||'append';$('#notificationModal .dns-list')[method](dnsTemplate({dns:results}));}
function showFeature(results,method){method=method||'append';$('#featureModal .feature-list')[method](featureTemplate({features:results}));}
$("body").popover({selector:'.user-name',html:true,placement:'bottom',trigger:'hover',content:function(){var userInfoId="userinfo-id-"+$.now();var userId=$(this).closest('[data-user]').data('user');if(!userId)return;return showUserInfo(userId,userInfoId);}});function showUserInfo(userId,userInfoId){$.getJSON('/user/'+userId).done(function(user){user&&$('#'+userInfoId).html(userInfoTemplate({user:user}));}).fail(function(){$('#'+userInfoId).html("Error");});return'<div id="'+userInfoId+'">Loading...</div>'}
$('body').on('click','.mention-link',function(){var el=$(this);var matches=$(this).html().match(/^([@ï¼ ]([a-z0-9_]{2,32}))(\([a-zA-Z0-9\x20]+\))?$/i);if(_.size(matches)<2)return;el.addClass('.disabled');$.getJSON('/user?username='+matches[2]).done(function(user){el.removeClass('.disabled');if(user&&user.id){window.location.href='/profile/'+user.id;}}).fail(function(){el.removeClass('.disabled');});});function notify(obj){if(!obj)return;Utils.notify(notifyTemplate({notification:obj}));}
function updateDiscussion(discussion){var ds=$('.discussion[data-discussion='+discussion.id+']');ds.find('.discussion-kindex').html(discussion.kindex);ds.find('.discussion-title').html(discussion.title);ds.find('.discussion-updated-at').timeago('update',discussion.updated_at);ds.find('.discussion-created-at').timeago('update',discussion.created_at);}
function updateUser(user){var u=$('[data-user='+user.id+']');u.find('.user-fsi').html(user.fsi);u.find('.user-name').html(user.name);}
$('.closable').on('click','.btn-close',function(){var $this=$(this);Utils.confirmBox({title:'Delete confirm',body:'Are you sure?',okCallback:function(){$.ajax({type:'DELETE',url:$this.data('url')}).done(function(){window.location.href=$this.data('backurl');});},cancelCallback:function(){}});});$('body').on('click','.tagsinput-add',function(){$('#tagModal').modal('show');if(!App.tagContext){App.tagContext=$.getJSON('/tags');}
App.tagContext.done(function(result){if(result&&result.length>0){var $tagsinput=$('.tagsinput');$('#tagModal .modal-dialog').html(tagModalTemplate({tags:result,exists:$tagsinput.tagExist.bind($tagsinput)}));}});});$('.tagmodal').on('input','.todo-search-field',function(){var query=$(this).val();if(!query){$('.tagmodal li').removeClass('hide');return;}
$('.tagmodal li').addClass('hide');$('.tagmodal li[data-titlelower^='+query.toLowerCase()+']').removeClass('hide');}).on('click','li',function(){var $this=$(this),$tagsinput=$('.tagsinput'),title=$this.data('tagtitle');if(!$this.hasClass('todo-done')&&$('.tagmodal').find('.todo-done').size()>=App.max_tags_allowed){Utils.showAlert("Maximum "+App.max_tags_allowed+" tags are allowed.");return;}
$this.toggleClass("todo-done");$tagsinput[$tagsinput.tagExist(title)?'removeTag':'addTag'](title);});$('#markdown-link').on('click',function(e){$('#markdown-help').toggleClass('hide');return false;});var messageUrl='http://'+window.location.hostname+':8082',socketjs=messageUrl+'/socket.io/socket.io.js';App.socketContext=$.getScript(socketjs).done(function(){var socket=App.socket=io.connect(messageUrl);socket.on('connect',function(){App&&App.loggedInContext&&App.loggedInContext.done(function(result){socket.emit('fs:ui:page:data',{user:result});});});socket.on("fs:channel:notification",function(data){var msg=JSON.parse(data);var currentCount=parseInt($('#notification_count').html()||0);showNotification([msg],'prepend');var $nc=$('#notification_count');$nc.html(currentCount+1);Utils.titleCount($nc.html());notify(msg);});socket.on("fs:channel:notification:discussion",function(data){var msg=JSON.parse(data);var currentCount=parseInt($('#notification_count').html()||0);showDN([msg],'prepend');var $nc=$('#notification_count');$nc.html(currentCount+1);Utils.titleCount($nc.html());});socket.on("fs:update:discussion",function(discussion){updateDiscussion(JSON.parse(discussion));});socket.on("fs:update:user",function(user){updateUser(JSON.parse(user));});socket.on("fs:channel:message",function(message){var message=JSON.parse(message);App&&App.loggedInContext&&App.loggedInContext.done(function(user){if(message.to_id==user.id){var currentCount=parseInt($('#message_count').html()||0);$("#message_count").html(currentCount+1);}});App.messageCallback&&App.messageCallback(message);});$(window).on('beforeunload',function(){socket.onclose=null;socket.disconnect();});});$(document).ready(function(){var form=$('form');if(form.size()>0){original=form.serialize();form.submit(function(){$(window).off('beforeunload');if(App.socket){App.socket.onclose=null;App.socket.disconnect();}});$(window).on('beforeunload',function(){if(form.serialize()!=original){return'Are you sure you want to leave?';}});}});})(jQuery);(function(root){$(".closable").on("click",".btn-share,.btn-unshare",function(e){e.preventDefault();var $this=$(this),postId=$this.data('post'),shared=$this.hasClass('btn-unshare');$this.addClass('disabled');$.ajax({type:shared?"DELETE":"POST",url:"/"+['post',postId,'share'].join("/"),dataType:'json'}).done(function(result){$this.removeClass('btn-info btn-danger btn-share btn-unshare disabled')
if(shared){$this.addClass('btn-share').html('Share on f(x)');if($this.hasClass('btn')){$this.addClass('btn-info');}}else{$this.addClass('btn-unshare').html('Unshare');if($this.hasClass('btn')){$this.addClass('btn-danger');}}
$('.btn-share-count[data-post='+postId+']').html(result.count);}).fail(function(xhr,errorType,msg){$this.removeClass('disabled');Utils.showAlert(Utils.error(xhr)||msg||'Unknown Error');});return false;});})(this);